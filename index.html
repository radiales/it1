<!doctype html>
<html>
	<head>
		<title>Noten lernen</title>
		<meta charset="utf-8">
		<style>
            *{
                font-family: Segoe UI, Helvetica, Trebuchet, Arial, Serif;
				font-size: 5vw;
            }
			
			body, html{
				overflow-y: hidden;
				position: relative;
			}
			
			body{
				margin: 0;
				padding: 0;
				border: 0;
				outline: 0;
				height: 100vh;
				width: 100vw;
			}
		
            .answer{
                display: block;
                background: #AFAFAF;
                margin-bottom: 5px;
                padding: 10px 10px 10px 10px;
				cursor: pointer;
				height: 7vh;
			}
			
			.answer:hover{
				background: #BFBFBF;
			}
			
			.selectable:hover{
				background: #BFBFBF !important;
			}
            
            #container{
                display: block;
                margin: 0 auto;
                width: 90%;
                text-align: center;
                background: #DFDFDF;
				height: 100vh;
				overflow: hidden;
				position: relative;
            }
			
			h1, h2, h3, h4{
				font-size: 12vw;
				margin: 0;
				padding: 10px;
			}
			
			@media only screen and (min-width: 1200px) {
				*{
					font-size: 12pt;
				}
			
				body{
					height: auto;
					overflow-y: hidden;
				}
			
				#container {
					border-radius: 25px;
					width: 80%;
					padding-bottom: 35px;
					padding-top: 25px;
					height: auto;
					margin-top: 25px;
				}
				
				h1, h2, h3, h4{
					font-size: 36pt;
				}
				
				#clefSelect *{
					line-height: normal !important;
					height: 10vh;
				}
				
				.clefOption{
					width: 39.5% !important;
					display: table-cell !important;
					
				}
				
				.answer{
					width: 45%;
					display: inline-block;
					height: auto;
				}
				
				#progressIndicator{
					height: 20px !important;
					padding: 5px 0 5px 0;
				}
				
				#scoreDiv{
					height: auto;
				}
			}
			
			#scoreDiv{
				height: 15vh;
			}
			
			#progressIndicator{
				margin-top: 25px;
				display: table;
				width: 100%;
				height: 4vh;
				background: white;
				padding: 10px 0px 10px 0px;
			}
			
			#progressBar{
				width: 0%;
				height: 100%;
				background: #a7e3bc;
				display: block;
			}
			
			#statistics{
				background: #CACACA;
				margin-top: 15px;
			}
			
			/*
			#app{
				display: none;
			}
			*/
			
			#start{
				//display: block;
				width: 100%;
				text-align: center;
			}
			
			#clefSelect{
				display: table;
				width: 80%;
				text-align: center;
				margin: 0 auto;
			}
			
			.clefOption{
				display: block;
				vertical-align: middle;
				width: 100%;
				background: #AFAFAF;
				margin: 5px;
				cursor: pointer;
				height: 35vh;
			}
			
			#setSelect{
				display: inline-block;
				width: 80%;
			}
			
			#clefSelect *{
				line-height: 32.5vh;
			}
			
			#quizSelect *{
				padding: 5px;
			}
			
			/*
			#startButton{
				display: inline-block;
				background: #AFAFAF;
				width: 80%;
				height: 10vh;
				cursor: pointer;
			}
			*/
			
			/*
			.selectedDiv{
				background: #BFBFBF;
			}
			*/
		</style>
	</head>
	<body>
        <script src="https://unpkg.com/vexflow@1.2.89/releases/vexflow-debug.js"></script>
        <div id="container">
			<h1>Noten lernen</h1>
			<div id="start">
				<div id="quizSelect">
					<select id="setSelect">
						<option>Set 1</option>
						<option>Set 2 (from Server)</option>
						<option>Set 3 (from Server)</option>
						<option>Set 4 (from Server)</option>
					</select>
					<div id="clefSelect">
						<div class="clefOption selectable" treble><span>Violinschlüssel</span></div>
						<div class="clefOption selectable" bass><span>Bassschlüssel</span></div>
					</div>
				</div>
			</div>
			<div id="app">
				<div id="scoreDiv"></div>
				<div id="answers">
					<div id="answer1" class="answer">a/3</div>
					<div id="answer2" class="answer">b/4</div>
					<div id="answer3" class="answer">d/4</div>
					<div id="answer4" class="answer">d/3</div>
				</div>
				<div id="statistics">
					<span>Statistik:</span><br>
					<canvas id="piechart" width="200" height="200">
					</canvas>
					<br>
					Richtige: <span id="correctNo">0</span>
					Falsche: <span id="wrongNo">0</span>
				</div>
				<div id="progressIndicator">
					<div id="progressBar"></div>
				</div>
			</div>
		</div>
		
		<script>
		"use strict";
		/*
		var vf = new Vex.Flow.Factory({
				renderer: {elementId: 'scoreDiv', width: 80, height: 125}
			});
	
			var score = vf.EasyScore();
			var system = vf.System();
	
			system.addStave({
				voices: [score.voice(score.notes('C4/q, B4, A4, G#4'))]
			}).addClef('treble');
	
			vf.draw();
		
		
		var vf = new Vex.Flow.Factory({
			renderer: {elementId: 'scoreDiv', width: 80, height: 125}
		});
		
		var score = vf.EasyScore();
		var system = vf.System();
		var notegroup;
		*/
		
		var VF = Vex.Flow;
		
		//Setting up note rendering
		function setupVF(note){
			
			if(document.querySelector("#scoreDiv").children.length > 0)
				document.querySelector("#scoreDiv").removeChild(document.querySelector("#scoreDiv svg"));
		
			var div = document.querySelector("#scoreDiv")
			var renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
			renderer.resize(150, 120);
			var context = renderer.getContext();
			
			var stave = new VF.Stave(10, 0, 100);
			stave.addClef(quizClef);
		
			var notes = [
				new VF.StaveNote({clef: quizClef, keys: [note], duration: "q" }),
	
				//placeholders, not acutally visible, lib requires them for some reason, ignore
				new VF.StaveNote({clef: "treble", keys: ["d/4"], duration: "q" }),
				new VF.StaveNote({clef: "treble", keys: ["b/4"], duration: "qr" }),
				new VF.StaveNote({clef: "treble", keys: ["c/4", "e/4", "g/4"], duration: "q" })
			];

			var voice = new VF.Voice({num_beats: 4,  beat_value: 4});
			voice.addTickables(notes);

			var formatter = new VF.Formatter().joinVoices([voice]).format([voice], 400);

			console.log("Resized.");
			context.setViewBox(0, 25, 90, 90);
			stave.setContext(context).draw();
			voice.draw(context, stave);
			/*
			if(window.innerWidth > 1199){
				//Desktop
				context.setViewBox(0, 25, 90, 90); //size
				document.querySelector("svg").width = "150";
				document.querySelector("svg").height = "120";
			} else{
				//Mobile
				//context.setViewBox(0, 25, 60, 60); //size
				document.querySelector("svg").width = "200";
				document.querySelector("svg").height = "200";
			}*/
		}
		
		//IGNORE
		function setupVFold(note){	
			if(document.querySelector("#scoreDiv").children.length > 0)
				document.querySelector("#scoreDiv").removeChild(document.querySelector("#scoreDiv svg"));
			
			var vf = new Vex.Flow.Factory({
				renderer: {elementId: 'scoreDiv', width: 80, height: 125}
			});
			
			var score = vf.EasyScore();
			var system = vf.System();
			var notegroup;
			
			notegroup = vf.context.openGroup();
		
			system.addStave({
				voices: [score.voice(score.notes(note+'/q, B4, A4, G#4'))]
			}).addClef('treble');

			vf.draw();
			
			vf.context.closeGroup();
		}
		
		var piechart = document.querySelector("#piechart");
		var pieChartContext = piechart.getContext("2d");
		
		var quizClef = "treble";
		var possibleNotes = ["b/3", "c/4", "d/4", "e/4", "f/4", "g/4", "a/4", "b/4", "c/5", "d/5", "e/5"];
		//var notes = ["D4", "C4", "E5", "F4", "H3"];
		var notes = ["d/4", "c/4", "e/5", "f/4", "b/3"];
		var questionCounter = 0;
		var correctNo = 0;
		var appResponse;
		
		setupVF(notes[questionCounter]);
		
		function setClef(clef){
			quizClef = clef;
			
			if(document.querySelector("#setSelect").selectedIndex != 0){
				console.log("Calling " + fetchQuestions);
				fetchQuestions();
			}
			
			setupVF(notes[questionCounter]);
			document.querySelector("#start").style.display = "none";
			document.querySelector("#app").style.display = "block";
		}
		
		//Draws a pie chart showing the relation between correct and incorrect answers 
		function drawPieChart(){
		
			var correctCount = correctNo;
			if(questionCounter == 0)
				correctCount = 1;
				
			var questionCounterAlt = questionCounter;
			if(questionCounter == 0)
				questionCounterAlt = 1;
		
			//green
			pieChartContext.moveTo(100, 100);
			pieChartContext.arc(100, 100, 90.5, 0, Math.PI*(correctCount/questionCounterAlt)*2);
			pieChartContext.fillStyle = "#a7e3bc";
			pieChartContext.fill();
			
			//red
			pieChartContext.beginPath();
			pieChartContext.moveTo(100, 100);
			pieChartContext.arc(100, 100, 90.5, Math.PI*(correctCount/questionCounterAlt)*2, Math.PI*2);
			pieChartContext.fillStyle = "#e19898";
			pieChartContext.fill();
		}
		
		//Updates question divs and VexFlow note display
		function update(){
			//function is ensured to never use one answer twice and selects random div for correct answer, fills others with incorrects
			var answers = document.querySelectorAll(".answer");
			var correctIndex = Math.floor(Math.random()*3);
			var lastIndex;
			var tempPossible = possibleNotes;
			
			//Re-set color after indicator color for answering
			for(var i = 0; i < answers.length; i++)
				answers[i].style.background = "#AFAFAF";
			
			
			if(questionCounter < notes.length){
				//Fills answer-divs
				answers[correctIndex].innerHTML = notes[questionCounter];
				for(var i = 0; i < 3; i++){
					if(i == correctIndex) continue;
					lastIndex = Math.floor(Math.random()*tempPossible.length);
					answers[i] = possibleNotes[lastIndex];
					tempPossible.splice(lastIndex, 1);
				}
				setupVF(notes[questionCounter]);
			}
			
			
			drawPieChart();
			document.querySelector("#correctNo").innerHTML = correctNo;
			document.querySelector("#wrongNo").innerHTML = questionCounter - correctNo;
			document.querySelector("#progressBar").style.width = questionCounter/notes.length*100 + "%";
			console.log("Progress percentage: " + questionCounter/notes.length*100 + "%");
		}
		
		//Is called when the user clicks on one of the answer divs, invokes update after 1 second, to show correct answer
		function answer(note){
			console.log("User answered.");
			var answers = document.querySelectorAll(".answer");
			console.log("Correct answer would be:" + notes[questionCounter]);
			console.log("Answer was:" + note);
			if(note == notes[questionCounter]){
				correctNo++;
			}
			
			for(var i = 0; i < answers.length; i++){
			console.log("innerHTML: " + answers[i].innerHTML);
			console.log("answer: " + notes[questionCounter]);
				if(answers[i].innerHTML == notes[questionCounter])
					answers[i].style.background = "#a7e3bc";
				else
					answers[i].style.background = "#e19898";
				//console.log("Div No. " + i + " innerHTML: " + answers[i].innerHTML);
			}
			
			
			setTimeout(update, 1000);
			questionCounter++;
		}
		
		//Setting up event-listeners for answering
		var answers = document.querySelectorAll(".answer");
		for(var i = 0; i < answers.length; i++){
			answers[i].addEventListener("click", function(){
				answer(this.innerHTML);
			});
		}
		
		var clefOptions = document.querySelectorAll(".clefOption");
		for(var i = 0; i < clefOptions.length; i++){
			clefOptions[i].addEventListener("click", function(){
				if(this.hasAttribute("treble"))
					setClef("treble");
				else
					setClef("bass");
			});
		}
		
		function fetchQuestions(){
			var xh = new XMLHttpRequest();
			xh.responseType = "json";
			
			xh.onreadystatechange = function(){
				if(this.readystate == 4 && this.status == 200){
					appResponse = this.response;
					console.log(this.response);
				}
			};
			xh.open("GET", "questions.json");
			xh.send();
		}
		
		//Initialize pie chart
		drawPieChart();
		//Hiding app, showing start div
		window.onload = function(){
			document.querySelector("#start").style.display = "block";
			document.querySelector("#app").style.display = "none";
		}
		</script>
	</body>
</html>
